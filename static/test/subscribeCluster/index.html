<!doctype html>
<html>
  <head>
    <title>Red5 Pro HTML SDK Testbed</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <meta content="width=device-width, initial-scale=1, user-scalable=no" name="viewport">
    <script src="../../lib/webrtc/adapter.js"></script>
    <script src="../../lib/videojs/video.min.js"></script>
    <script src="../../lib/videojs/videojs-media-sources.min.js"></script>
    <script src="../../lib/videojs/videojs.hls.min.js"></script>
    <link rel="stylesheet" href="../../lib/videojs/video-js.min.css">
    <link rel="stylesheet" href="../../css/reset.css">
    <link rel="stylesheet" href="../../css/testbed.css">
    <script src="../../script/testbed-config.js"></script>
  </head>
  <body>
    <div id="app">
        <div id="back-link-container" style="text-align: left;"><p id="back-link"><a href="../../settings.html">&lt; Settings</a></p></div>
        <h1 class="centered">Subscriber Cluster Test</h1>
        <hr />
        <h2 class="centered"><em>stream</em>: <span id="stream-title"></span></h2>
        <p id="status-field" class="centered status-field">On hold.</p>
        <div class="centered">
          <video id="red5pro-subscriber-video" controls class="video-element"></video>
        </div>
    </div>
    <script src="../../lib/es6/es6-promise.min.js"></script>
    <script src="../../lib/es6/es6-bind.js"></script>
    <script src="../../lib/es6/es6-object-assign.js"></script>
    <script src="../../lib/red5pro/red5pro-sdk.js"></script>
    <script>
      (function(window, document, red5pro) {
        var configuration = (function () {
          var conf = sessionStorage.getItem('r5proTestBed');
          try {
            return JSON.parse(conf);
          }
          catch (e) {
            console.error('Could not read testbed configuration from sessionstorage: ' + e.message);
          }
          return {}
        })();

        red5pro.setLogLevel(configuration.verboseLogging ? red5pro.LogLevels.TRACE : red5pro.LogLevels.WARN);

        var targetSubscriber;
        var targetView;

        var instanceId = Math.floor(Math.random() * 0x10000).toString(16);
        var statusField = document.getElementById('status-field');
        var streamTitle = document.getElementById('stream-title');

        var defaultConfiguration = {
          protocol: 'ws',
          port: 8081,
          app: 'live',
          bandwidth: {
            audio: 50,
            video: 256,
            data: 30 * 1000 * 1000
          }
        }

        function shutdownVideoElement () {
          var videoElement = document.getElementById('red5pro-publisher-video');
          if (videoElement) {
            videoElement.pause()
            videoElement.src = ''
          }
        }

        // Displays in status field based on events from subscriber instance.
        function updateStatusFromEvent (event, field) {
          var subTypes = red5prosdk.SubscriberEventTypes;
          var rtcTypes = red5prosdk.RTCSubscriberEventTypes;
          var status;
          switch (event.type) {
            case subTypes.CONNECT_SUCCESS:
              status = 'Connection established...';
              break;
            case subTypes.CONNECT_FAILURE:
              status = 'Error - Could not establish connection.';
              shutdownVideoElement();
              break;
            case subTypes.SUBSCRIBE_START:
              status = 'Started subscribing session.';
              break;
            case subTypes.SUBSCRIBE_FAIL:
              status = 'Error - Could not start a subscribing session.';
              shutdownVideoElement();
              break;
            case subTypes.SUBSCRIBE_INVALID_NAME:
              status = 'Error - Stream name not in use.';
              break;
            case rtcTypes.OFFER_START:
              status = 'Begin offer...';
              break;
            case rtcTypes.OFFER_END:
              status = 'Offer accepted...';
              break;
            case rtcTypes.ANSWER_START:
              status = 'Sending answer...';
              answer = JSON.stringify(event.data, null, 2);
              console.log('[SubscriberStatus] ' + event.type + ': ' + answer);
              break
            case rtcTypes.ANSWER_END:
              status = 'Answer received...';
              break
            case rtcTypes.CANDIDATE_START:
              status = 'Sending candidate...';
              candidate = JSON.stringify(event.data, null, 2);
              console.log('[SubscriberStatus] ' + event.type + ': ' + candidate);
              break
            case rtcTypes.CANDIDATE_END:
              status = 'Candidate received...';
              break;
            case rtcTypes.ICE_TRICKLE_COMPLETE:
              status = 'Negotiation complete. Waiting Subscription Start...';
              break;
          }
          field.innerText = ['STATUS', status].join(': ');
        }

        // Local lifecycle notifications.
        function onSubscriberEvent (event) {
          console.log('[Red5ProSubsriber] ' + event.type + '.');
          updateStatusFromEvent(event, statusField);
        }
        function onSubscribeFail (message) {
          console.error('[Red5ProSubsriber] Subscribe Error :: ' + message);
        }
        function onSubscribeSuccess () {
          console.log('[Red5ProSubsriber] Subscribe Complete.');
        }
        function onUnsubscribeFail (message) {
          console.error('[Red5ProSubsriber] Unsubscribe Error :: ' + message);
        }
        function onUnsubscribeSuccess () {
          console.log('[Red5ProSubsriber] Unsubscribe Complete.');
        }

        function requestEdge (host) {
          var url = 'http://' + host + ':5080/cluster';
          return new Promise((resolve, reject) => {
            fetch(url)
              .then(function (res) {
                if (res.headers.get("content-type") &&
                    res.headers.get("content-type").toLowerCase().indexOf("text/plain") >= 0) {
                  res.text().then(value => {
                    resolve(value.substring(0, value.indexOf(':')))
                  })
                }
                else {
                  reject(res)
                }
              })
              .catch(function (error) {
                var jsonError = typeof error === 'string' ? error : JSON.stringify(error, null, 2)
                console.error('[SubscriberClusterTest] :: Error - Could not requst Edge IP. ' + jsonError)
                reject(error)
              });
          });
        }

        // Request to start subscribing using an overlayed configuration from local default and local storage.
        function subscribe (host) {
          var config = Object.assign({}, configuration, defaultConfiguration);
          config.host = host;
          config.streamName = config.stream1;
          console.log('[Red5ProSubscriber] config:: ' + JSON.stringify(config, null, 2));

          // Setup view.
          var view = new red5prosdk.PlaybackView('red5pro-subscriber-video');
          var subscriber = new red5prosdk.RTCSubscriber();
          var origAttachStream = view.attachStream.bind(view);
          view.attachStream = function (stream, autoplay) {
            origAttachStream(stream, autoplay)
            view.attachStream = origAttachStream
          };
          view.attachSubscriber(subscriber);
          streamTitle.innerText = config.streamName;

          targetSubscriber = subscriber;
          targetView = view;

          // Subscribe to events.
          subscriber.on('*', onSubscriberEvent);
          // Initiate playback.
          subscriber.init(config)
            .then(function (player) {
              return player.play();
            })
            .then(function () {
              onSubscribeSuccess()
            })
            .catch(function (error) {
              var jsonError = typeof error === 'string' ? error : JSON.stringify(error, null, 2)
              onSubscribeFail('Error - ' + jsonError);
            });
        }

        // Request to unsubscribe.
        function unsubscribe () {
          return new Promise(function(resolve, reject) {
            var view = targetView
            var subscriber = targetSubscriber
            if (subscriber) {
              subscriber.stop()
                .then(function () {
                  view.view.src = ''
                  subscriber.setView(undefined)
                  subscriber.off('*', onSubscriberEvent);
                  onUnsubscribeSuccess();
                  resolve();
                })
                .catch(function (error) {
                  var jsonError = typeof error === 'string' ? error : JSON.stringify(error, null, 2);
                  onUnsubscribeFail('Unmount Error = ' + jsonError);
                  reject('Could not unsubscribe: ' + error);
                });
            }
            else {
              resolve()
            }
          });
        }

        // Kick off.
        requestEdge(configuration.host)
          .then(subscribe)
          .catch(function (error) {
            onSubscribeFail(error);
            console.error('Could not subscriber with Edge IP: ' + error);
          });

        // Clean up.
        window.addEventListener('beforeunload', function() {
          function clearRefs () {
            targetSubscriber.off('*', onSubscriberEvent);
            targetSubscriber = targetView = undefined;
          }
          unsubscribe().then(clearRefs).catch(clearRefs);
        });

      })(this, document, window.red5prosdk);
    </script>
  </body>
</html>
