<!doctype html>
<html>
  <head>
    <title>Red5 Pro HTML SDK Testbed</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <meta content="width=device-width, initial-scale=1, user-scalable=no" name="viewport">
    <script src="lib/webrtc/adapter.js"></script>
    <script src="lib/videojs/video.min.js"></script>
    <script src="lib/videojs/videojs-media-sources.min.js"></script>
    <script src="lib/videojs/videojs.hls.min.js"></script>
    <link rel="stylesheet" href="lib/videojs/video-js.min.css">
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/testbed.css">
    <style>
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <script>
      // Defining/accessing testbed configuration.
      (function () {
          var config = localStorage.getItem('r5proTestBed');
          var json;
          function assignStorage () {
            json = {
                "host": "localhost",
                "port": 8081,
                "stream1": "stream1",
                "stream2": "stream2",
                "app": "live",
                "cameraWidth": 854,
                "cameraHeight": 480,
                "video": true,
                "audio": true,
                "buffer": 0.5,
                "bitrate": 1000,
                "iceServers": [
                  {
                    "urls": "stun:stun2.l.google.com:19302"
                  }
                ]
              };
            localStorage.setItem('r5proTestBed', JSON.stringify(json));
          }
          if (config) {
            try {
              json = JSON.parse(config);
            }
            catch (e) {
              assignStorage();
            }
          }
          else {
            assignStorage();
          }
          return json;
        })();
    </script>
    <div id="app">
        <div id="back-link-container"><p id="back-link">Settings</p></div>
        <div id="settings-container" class="hidden">
          <h1 class="centered">Settings</h1>
          <p class="settings-field">
            <label class="settings-label">Host:</label>
            <input name="host-field" value="localhost">
          </p>
          <p class="settings-field">
            <label class="settings-label">Stream1 Name:</label>
            <input name="stream1-field" value="stream1">
          </p>
          <p class="settings-field swap-streams-link"><span>Swap Stream Names</span></p>
          <p class="settings-field">
            <label class="settings-label">Stream2 Name:</label>
            <input name="stream2-field" value="stream2">
          </p>
          <hr />
        </div>
        <h1 class="centered">Subscriber Test</h1>
        <hr />
        <h2 class="centered"><em>stream</em>: <span id="stream-title"></span></h2>
        <p id="status-field" class="centered status-field">On hold.</p>
        <div class="centered">
          <video id="red5pro-subscriber-video" controls class="video-element"></video>
        </div>
    </div>
    <script src="lib/es6/es6-promise.min.js"></script>
    <script src="lib/es6/es6-bind.js"></script>
    <script src="lib/es6/es6-object-assign.js"></script>
    <script src="lib/red5pro/red5pro-sdk.js"></script>
    <script>
      (function(window, document, red5pro) {
        red5pro.setLogLevel(red5pro.LogLevels.WARN);

        var targetSubscriber;
        var targetView;

        var instanceId = Math.floor(Math.random() * 0x10000).toString(16);
        var statusField = document.getElementById('status-field');
        var streamTitle = document.getElementById('stream-title');

        var configuration = (function () {
          var conf = localStorage.getItem('r5proTestBed');
          try {
            return JSON.parse(conf);
          }
          catch (e) {
            console.error('Could not read testbed configuration from localstorage: ' + e.message);
          }
          return {}
        })();
        var defaultConfiguration = {
          protocol: 'ws',
          port: 8081,
          app: 'live',
          bandwidth: {
            audio: 50,
            video: 256,
            data: 30 * 1000 * 1000
          }
        }

        // Displays in status field based on events from subscriber instance.
        function updateStatusFromEvent (event, field) {
          var subTypes = red5prosdk.SubscriberEventTypes;
          var rtcTypes = red5prosdk.RTCSubscriberEventTypes;
          var status;
          switch (event.type) {
            case subTypes.CONNECT_SUCCESS:
              status = 'Connection established...';
              break;
            case subTypes.CONNECT_FAILURE:
              status = 'Error - Could not establish connection.';
              break;
            case subTypes.SUBSCRIBE_START:
              status = 'Started subscribing session.';
              break;
            case subTypes.SUBSCRIBE_FAIL:
              status = 'Error - Could not start a subscribing session.';
              break;
            case subTypes.SUBSCRIBE_INVALID_NAME:
              status = 'Error - Stream name not in use.';
              break;
            case rtcTypes.OFFER_START:
              status = 'Begin offer...';
              break;
            case rtcTypes.OFFER_END:
              status = 'Offer accepted...';
              break;
            case rtcTypes.ANSWER_START:
              status = 'Sending answer...';
              answer = JSON.stringify(event.data, null, 2);
              console.log('[SubscriberStatus] ' + event.type + ': ' + answer);
              break
            case rtcTypes.ANSWER_END:
              status = 'Answer received...';
              break
            case rtcTypes.CANDIDATE_START:
              status = 'Sending candidate...';
              candidate = JSON.stringify(event.data, null, 2);
              console.log('[SubscriberStatus] ' + event.type + ': ' + candidate);
              break
            case rtcTypes.CANDIDATE_END:
              status = 'Candidate received...';
              break;
            case rtcTypes.ICE_TRICKLE_COMPLETE:
              status = 'Negotiation complete. Waiting Subscription Start...';
              break;
          }
          field.innerText = ['STATUS', status].join(': ');
        }

        // Local lifecycle notifications.
        function onSubscriberEvent (event) {
          console.log('[Red5ProSubsriber] ' + event.type + '.');
          updateStatusFromEvent(event, statusField);
        }
        function onSubscribeFail (message) {
          console.error('[Red5ProSubsriber] Subscribe Error :: ' + message);
        }
        function onSubscribeSuccess () {
          console.log('[Red5ProSubsriber] Subscribe Complete.');
        }
        function onUnsubscribeFail (message) {
          console.error('[Red5ProSubsriber] Unsubscribe Error :: ' + message);
        }
        function onUnsubscribeSuccess () {
          console.log('[Red5ProSubsriber] Unsubscribe Complete.');
        }

        // Request to start subscribing using an overlayed configuration from local default and local storage.
        function subscribe () {
          var config = Object.assign({}, configuration, defaultConfiguration);
          config.streamName = config.stream1;
          console.log('[Red5ProSubscriber] config:: ' + JSON.stringify(config, null, 2));

          // Setup view.
          var view = new red5prosdk.PlaybackView('red5pro-subscriber-video');
          var subscriber = new red5prosdk.RTCSubscriber();
          var origAttachStream = view.attachStream.bind(view);
          view.attachStream = function (stream, autoplay) {
            origAttachStream(stream, autoplay)
            view.attachStream = origAttachStream
          };
          view.attachSubscriber(subscriber);
          streamTitle.innerText = config.streamName;

          targetSubscriber = subscriber;
          targetView = view;

          // Subscribe to events.
          subscriber.on('*', onSubscriberEvent);
          // Initiate playback.
          subscriber.init(config)
            .then(function (player) {
              return player.play();
            })
            .then(function () {
              onSubscribeSuccess()
            })
            .catch(function (error) {
              var jsonError = typeof error === 'string' ? error : JSON.stringify(error, null, 2)
              onSubscribeFail('Error - ' + jsonError);
            });
        }

        // Request to unsubscribe.
        function unsubscribe () {
          return new Promise(function(resolve, reject) {
            var view = targetView
            var subscriber = targetSubscriber
            if (subscriber) {
              subscriber.stop()
                .then(function () {
                  view.view.src = ''
                  subscriber.setView(undefined)
                  subscriber.off('*', onSubscriberEvent);
                  onUnsubscribeSuccess();
                  resolve();
                })
                .catch(function (error) {
                  var jsonError = typeof error === 'string' ? error : JSON.stringify(error, null, 2);
                  onUnsubscribeFail('Unmount Error = ' + jsonError);
                  reject('Could not unsubscribe: ' + error);
                });
            }
            else {
              resolve()
            }
          });
        }

        // Kick off.
        subscribe();

        // Clean up.
        window.addEventListener('beforeunload', function() {
          function clearRefs () {
            targetSubscriber.off('*', onSubscriberEvent);
            targetSubscriber = targetView = undefined;
          }
          unsubscribe().then(clearRefs).catch(clearRefs);
        });

      })(this, document, window.red5prosdk);
    </script>
    <script>
      (function (window, document, red5pro) {

        var configuration = (function () {
          var conf = localStorage.getItem('r5proTestBed');
          try {
            return JSON.parse(conf);
          }
          catch (e) {
            console.error('Could not read testbed configuration from localstorage: ' + e.message);
          }
          return {}
        })();

        var settingsLink = document.getElementById('back-link-container');
        var settingsContainer = document.getElementById('settings-container');
        settingsLink.addEventListener('click', function () {
          settingsContainer.classList.toggle('hidden');
        });

       })(this, document, window.red5prosk);
    </script>
  </body>
</html>
